# Android

Platform-specific information for running Mystral Native.js on Android.

## Overview

Android support allows you to embed Mystral Native.js in native Android applications. Games run via Vulkan with the wgpu-native backend.

## System Requirements

- Android 8.0 (API 26) or later
- Vulkan 1.1+ capable GPU
- arm64-v8a architecture
- Android NDK r25+

## Recommended Configuration

| JS Engine | WebGPU Backend | Notes |
|-----------|----------------|-------|
| QuickJS | wgpu-native | Small binary, no JIT |

**QuickJS** is recommended for Android as it provides a small footprint and doesn't require JIT (which can be restricted on some devices).

## Integration

### Kotlin

```kotlin
import com.mystral.native.MystralRuntime
import com.mystral.native.MystralConfig

class GameActivity : Activity(), SurfaceHolder.Callback {
    private lateinit var runtime: MystralRuntime
    private lateinit var surfaceView: SurfaceView

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        surfaceView = SurfaceView(this)
        setContentView(surfaceView)
        surfaceView.holder.addCallback(this)
    }

    override fun surfaceCreated(holder: SurfaceHolder) {
        val config = MystralConfig().apply {
            width = surfaceView.width
            height = surfaceView.height
        }

        runtime = MystralRuntime(config, holder.surface)

        // Load script from assets
        val scriptPath = copyAssetToFiles("game.js")
        runtime.loadScript(scriptPath)
        runtime.run()
    }

    override fun surfaceChanged(holder: SurfaceHolder, format: Int, width: Int, height: Int) {
        runtime.resize(width, height)
    }

    override fun surfaceDestroyed(holder: SurfaceHolder) {
        runtime.stop()
    }

    private fun copyAssetToFiles(assetName: String): String {
        val outFile = File(filesDir, assetName)
        assets.open(assetName).use { input ->
            outFile.outputStream().use { output ->
                input.copyTo(output)
            }
        }
        return outFile.absolutePath
    }
}
```

### Java

```java
public class GameActivity extends Activity implements SurfaceHolder.Callback {
    private MystralRuntime runtime;
    private SurfaceView surfaceView;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        surfaceView = new SurfaceView(this);
        setContentView(surfaceView);
        surfaceView.getHolder().addCallback(this);
    }

    @Override
    public void surfaceCreated(SurfaceHolder holder) {
        MystralConfig config = new MystralConfig();
        config.setWidth(surfaceView.getWidth());
        config.setHeight(surfaceView.getHeight());

        runtime = new MystralRuntime(config, holder.getSurface());
        runtime.loadScript(getFilesDir() + "/game.js");
        runtime.run();
    }

    @Override
    public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) {
        runtime.resize(width, height);
    }

    @Override
    public void surfaceDestroyed(SurfaceHolder holder) {
        runtime.stop();
    }
}
```

## Building for Android

### Prerequisites

1. Install Android NDK r25+
2. Set `ANDROID_NDK_HOME` environment variable

### CMake Build

```bash
cmake -B build-android \
    -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
    -DANDROID_ABI=arm64-v8a \
    -DANDROID_PLATFORM=android-26 \
    -DMYSTRAL_USE_QUICKJS=ON \
    -DMYSTRAL_USE_WGPU=ON

cmake --build build-android
```

### Gradle Integration

Add to your `build.gradle`:

```groovy
android {
    defaultConfig {
        ndk {
            abiFilters 'arm64-v8a'
        }
    }

    externalNativeBuild {
        cmake {
            path "CMakeLists.txt"
            arguments "-DMYSTRAL_USE_QUICKJS=ON",
                      "-DMYSTRAL_USE_WGPU=ON"
        }
    }
}
```

## Touch Input

Handle touch events:

```kotlin
surfaceView.setOnTouchListener { _, event ->
    when (event.actionMasked) {
        MotionEvent.ACTION_DOWN, MotionEvent.ACTION_POINTER_DOWN -> {
            val index = event.actionIndex
            val id = event.getPointerId(index)
            runtime.onTouchStart(id, event.getX(index), event.getY(index))
        }
        MotionEvent.ACTION_MOVE -> {
            for (i in 0 until event.pointerCount) {
                val id = event.getPointerId(i)
                runtime.onTouchMove(id, event.getX(i), event.getY(i))
            }
        }
        MotionEvent.ACTION_UP, MotionEvent.ACTION_POINTER_UP -> {
            val index = event.actionIndex
            val id = event.getPointerId(index)
            runtime.onTouchEnd(id)
        }
    }
    true
}
```

## Gamepad Support

Android supports gamepads via InputDevice:

```kotlin
override fun onGenericMotionEvent(event: MotionEvent): Boolean {
    if (event.source and InputDevice.SOURCE_JOYSTICK == InputDevice.SOURCE_JOYSTICK) {
        val leftX = event.getAxisValue(MotionEvent.AXIS_X)
        val leftY = event.getAxisValue(MotionEvent.AXIS_Y)
        // Forward to runtime
        return true
    }
    return super.onGenericMotionEvent(event)
}

override fun onKeyDown(keyCode: Int, event: KeyEvent): Boolean {
    if (event.source and InputDevice.SOURCE_GAMEPAD == InputDevice.SOURCE_GAMEPAD) {
        // Handle gamepad button
        return true
    }
    return super.onKeyDown(keyCode, event)
}
```

## Permissions

Add to `AndroidManifest.xml` if needed:

```xml
<!-- For network requests -->
<uses-permission android:name="android.permission.INTERNET" />

<!-- For vibration feedback -->
<uses-permission android:name="android.permission.VIBRATE" />

<!-- Require Vulkan -->
<uses-feature android:name="android.hardware.vulkan.level" android:version="1" />
```

## Known Issues

- **Vulkan support**: Some older devices may not support Vulkan 1.1
- **QuickJS JIT**: QuickJS doesn't use JIT, which may impact performance for complex JS
- **Lifecycle**: Properly handle Activity lifecycle to avoid resource leaks

## Performance Tips

- Use arm64-v8a only to reduce APK size
- Compress textures (ASTC or ETC2)
- Profile with Android Studio Profiler
- Consider reducing resolution on mid-range devices

## Next Steps

- [Embedding](/mystralnative/docs/api/embedding) - C++ embedding API
- [JavaScript APIs](/mystralnative/docs/api/javascript) - Supported APIs
