# iOS

Platform-specific information for running Mystral Native.js on iOS.

## Overview

iOS support allows you to embed Mystral Native.js in native iOS applications. Games run via Metal with the wgpu-native backend.

## System Requirements

- iOS 15.0 or later
- A14 Bionic chip or later (for best WebGPU compatibility)
- Xcode 14+

## Recommended Configuration

| JS Engine | WebGPU Backend | Notes |
|-----------|----------------|-------|
| JSC | wgpu-native | Uses system JavaScriptCore, smallest binary |
| QuickJS | wgpu-native | Standalone, no system dependencies |

**JavaScriptCore (JSC)** is recommended for iOS as it uses the system JavaScript engine, reducing binary size.

## Integration

### SwiftUI

```swift
import SwiftUI
import MystralNative

struct GameView: View {
    @State private var runtime: MystralRuntime?

    var body: some View {
        MystralMetalView(runtime: $runtime)
            .onAppear {
                setupRuntime()
            }
    }

    func setupRuntime() {
        let config = MystralConfig()
        runtime = MystralRuntime(config: config)
        runtime?.loadScript(Bundle.main.path(forResource: "game", ofType: "js")!)
    }
}
```

### UIKit

```swift
import UIKit
import MystralNative

class GameViewController: UIViewController {
    private var metalView: MTKView!
    private var runtime: MystralRuntime!

    override func viewDidLoad() {
        super.viewDidLoad()

        metalView = MTKView(frame: view.bounds)
        metalView.device = MTLCreateSystemDefaultDevice()
        view.addSubview(metalView)

        let config = MystralConfig()
        config.width = Int(view.bounds.width * UIScreen.main.scale)
        config.height = Int(view.bounds.height * UIScreen.main.scale)

        runtime = MystralRuntime(config: config, metalView: metalView)
        runtime.loadScript(Bundle.main.path(forResource: "game", ofType: "js")!)
    }

    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        runtime.run()
    }
}
```

## Building for iOS

### Using CMake

```bash
cmake -B build-ios \
    -DCMAKE_SYSTEM_NAME=iOS \
    -DCMAKE_OSX_ARCHITECTURES=arm64 \
    -DCMAKE_OSX_DEPLOYMENT_TARGET=15.0 \
    -DMYSTRAL_USE_JSC=ON \
    -DMYSTRAL_USE_WGPU=ON

cmake --build build-ios
```

### Xcode Project

1. Build the iOS framework:
   ```bash
   cmake -B build-ios -GXcode -DCMAKE_SYSTEM_NAME=iOS
   open build-ios/MystralNative.xcodeproj
   ```

2. Add framework to your app project
3. Embed and sign the framework

## Touch Input

Handle touch events and forward to the runtime:

```swift
override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
    for touch in touches {
        let location = touch.location(in: metalView)
        let id = ObjectIdentifier(touch).hashValue
        runtime.onTouchStart(id: id, x: Float(location.x), y: Float(location.y))
    }
}

override func touchesMoved(_ touches: Set<UITouch>, with event: UIEvent?) {
    for touch in touches {
        let location = touch.location(in: metalView)
        let id = ObjectIdentifier(touch).hashValue
        runtime.onTouchMove(id: id, x: Float(location.x), y: Float(location.y))
    }
}

override func touchesEnded(_ touches: Set<UITouch>, with event: UIEvent?) {
    for touch in touches {
        let id = ObjectIdentifier(touch).hashValue
        runtime.onTouchEnd(id: id)
    }
}
```

## Gamepad Support

iOS 14+ supports game controllers via GCController:

```swift
import GameController

NotificationCenter.default.addObserver(
    forName: .GCControllerDidConnect,
    object: nil,
    queue: .main
) { notification in
    if let controller = notification.object as? GCController {
        // Forward controller state to runtime
    }
}
```

## App Store Guidelines

- Ensure game content complies with App Store guidelines
- Include proper privacy descriptions if using network features
- Test on physical devices before submission

## Known Issues

- **Metal validation**: May show warnings on older devices
- **Memory**: Monitor memory usage on older devices with less RAM
- **Background**: App may be suspended when backgrounded

## Performance Tips

- Use JSC for smaller binary size
- Optimize JavaScript for mobile performance
- Consider reducing render resolution on older devices
- Use texture compression (ASTC) for assets

## Next Steps

- [Embedding](/mystralnative/docs/api/embedding) - C++ embedding API
- [JavaScript APIs](/mystralnative/docs/api/javascript) - Supported APIs
